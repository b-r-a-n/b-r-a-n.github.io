<!DOCTYPE html>
<html>
<head>
  <title>Warrior Report Card</title>
  <style>
  .Warrior {color: #C79C6E; font-weight: bold}
  .Warlock {color: #9482C9; font-weight: bold}
  .Shaman {color: #0070DE; font-weight: bold}
  .Rogue {color: #FFF569; font-weight: bold}
  .Priest {color: #000000; font-weight: bold}
  .Paladin {color: #F58CBA; font-weight: bold}
  .Mage {color: #69CCF0; font-weight: bold}
  .Hunter {color: #ABD473; font-weight: bold}
  .Druid {color: #FF7D0A; font-weight: bold}
  </style>
</head>
<body>
  <form id='form'>
    <label for='reportid'>WCL Report Id:</label><br>
    <input type='text' id='reportid' name='reportid' placeholder='TKrgqcmX9yY7zfbQ'>
    <br>
    <br>
    <label for='apikey'>WCL API Key:</label><br>
    <input type='text' id='apikey' name='apikey' placeholder='3950yourkeyfromwclhere0323c'>
    <br>
    <br>
    <input type='submit' value='Submit'>
  </form>
  <br>
  <div id='errormessage'></div>
  <br>
  <table>
    <thead>
      <tr id='result-header-row'>
        <td>Player</td><td>Damage</td><td>Melee</td><td>Miss%</td><td>Crit%</td>
        <td>Parry%</td><td>BTs</td><td>Sunders</td><td>HSs</td>
        <td>Executes</td><td>DF%</td><td>Flurry%</td><td>Windfury%</td><td>Procs</td>
        <td>Crusdaer%</td><td>Reck%</td><td>Blood Fury</td>
      </tr>
    </thead>
    <tbody id='result-table-body'></tbody>
  </table>
  <ul id='warrior-list'></ul>
  <script>
  Storage.prototype.setObject = function(key, value) {
    this.setItem(key, JSON.stringify(value));
  }
  Storage.prototype.getObject = function(key) {
    var value = this.getItem(key);
    return value && JSON.parse(value);
  }
  function formatNumber(num) {
    return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')
  }
  function createWarriorElement(summary) {
    var tr = document.createElement('tr');
    tr.id = 'warrior-' + summary.name;
    var td = document.createElement('td');
    td.appendChild(document.createTextNode(summary.name));
    tr.appendChild(td);
    var td = document.createElement('td');
    td.appendChild(document.createTextNode(formatNumber(summary.totalDamage)));
    tr.appendChild(td);
    var td = document.createElement('td');
    td.appendChild(document.createTextNode(formatNumber(summary.meleeAttempts)));
    tr.appendChild(td);
    var missRate = summary.meleeMisses / summary.meleeAttempts;
    var td = document.createElement('td');
    td.appendChild(document.createTextNode((missRate*100).toPrecision(3)));
    tr.appendChild(td);
    var critRate = summary.critHits / summary.totalAttacks;
    var td = document.createElement('td');
    td.appendChild(document.createTextNode((critRate*100).toPrecision(3)));
    tr.appendChild(td);
    var parryRate = summary.totalParries / summary.totalAttacks;
    var td = document.createElement('td');
    td.appendChild(document.createTextNode((parryRate*100).toPrecision(3)));
    tr.appendChild(td);
    var td = document.createElement('td');
    td.appendChild(document.createTextNode(formatNumber(summary.bloodThirsts)));
    tr.appendChild(td);
    var td = document.createElement('td');
    td.appendChild(document.createTextNode(formatNumber(summary.sunders)));
    tr.appendChild(td);
    var td = document.createElement('td');
    td.appendChild(document.createTextNode(formatNumber(summary.heroicStrikes)));
    tr.appendChild(td);
    var td = document.createElement('td');
    td.appendChild(document.createTextNode(formatNumber(summary.executes)));
    tr.appendChild(td);
    var td = document.createElement('td');
    td.appendChild(document.createTextNode((summary.diamondFlaskUptime*100).toPrecision(3)));
    tr.appendChild(td);
    var td = document.createElement('td');
    td.appendChild(document.createTextNode((summary.flurryUptime*100).toPrecision(3)));
    tr.appendChild(td);
    var td = document.createElement('td');
    td.appendChild(document.createTextNode((summary.windfuryUptime*100).toPrecision(3)));
    tr.appendChild(td);
    var td = document.createElement('td');
    td.appendChild(document.createTextNode(formatNumber(summary.windfuryUses)));
    tr.appendChild(td);
    var td = document.createElement('td');
    td.appendChild(document.createTextNode((summary.crusaderUptime*100).toPrecision(3)));
    tr.appendChild(td);
    var td = document.createElement('td');
    td.appendChild(document.createTextNode((summary.recklessnessUptime*100).toPrecision(3)));
    tr.appendChild(td);
    var td = document.createElement('td');
    td.appendChild(document.createTextNode(formatNumber(summary.bloodFuries)));
    tr.appendChild(td);
    return tr;
  }
  function totalDamage(entries) {
    var total = 0;
    entries.forEach(function(entry) {
      total += entry['total'];
    });
    return total;
  }
  function missPercent(entries) {
    var total = 0;
    var misses = 0;
    entries.forEach(function(entry) {
      if (entry['name'] == 'Melee') {
        total += entry['hitCount'] + entry['missCount'];
        entry['missdetails'].forEach(function(miss) {
          if (miss['type'] == 'Miss') {
            misses += miss['count'];
          }
        });
      }
    });
    if (total < 1) { return [0, 0]; }
    return [misses, total];
  }
  function countExecutes(entries) {
    var total = 0;
    entries.forEach(function(entry) {
      if (entry['name'] == 'Execute') {
        total += entry['hitCount'] + entry['missCount'];
      }
    });
    return total;
  }
  function critPercent(entries) {
    var crits = 0;
    var total = 0;
    entries.forEach(function(entry) {
      total += entry['hitCount'] + entry['missCount'];
      crits += entry['critHitCount'];
    });
    return [crits, total];
  }
  function parryPercent(entries) {
    var parries = 0;
    var total = 0;
    entries.forEach(function(entry) {
      total += entry['hitCount'] + entry['missCount'];
      entry['missdetails'].forEach(function(miss) {
        if (miss['type'] == 'Parry') {
          parries += miss['count'];
        }
      });
    });
    return [parries, total];
  }
  function castCounts(entries) {
    var result = {};
    entries.forEach(function(entry) {
      if (!result[entry['name']]) {
        result[entry['name']] = 0;
      }
      result[entry['name']] += entry['total'];
    });
    return result;
  }
  function buffUptimes(entries) {
    var result = {};
    entries.auras.forEach(function(entry) {
      var buff = {};
      buff['totalUptime'] = entry.totalUptime;
      buff['totalUses'] = entry.totalUses;
      result[entry.name] = buff;
    });
    return result;
  }
  function fetchBuffs(reportId, apiKey, sourceId) {
    var url = 'https://classic.warcraftlogs.com:443/v1/report/tables/buffs/'
    + reportId + '?end=1000000000000&targetid=' + sourceId
    + '&filter=' + encodeURIComponent('encounterID in (610, 611, 612, 613, 614, 615, 616, 617, 631)')
    + '&api_key=' + apiKey;
    return fetch(url).then(function(response) {
      return response.json();
    }).then(function(json) {
      var buffs = buffUptimes(json);
      buffs['type'] = 'buffs';
      buffs['sourceId'] = sourceId;
      buffs['totalTime'] = json['totalTime'];
      return buffs;
    });
  }
  function fetchCasts(reportId, apiKey, sourceId) {
    var url = 'https://classic.warcraftlogs.com:443/v1/report/tables/casts/'
    + reportId + '?end=1000000000000&sourceid=' + sourceId
    + '&filter=' + encodeURIComponent('encounterID in (610, 611, 612, 613, 614, 615, 616, 617, 631)')
    + '&api_key=' + apiKey;
    return fetch(url).then(function(response) {
      return response.json();
    }).then(function(json) {
      var casts = castCounts(json['entries']);
      casts['type'] = 'casts';
      casts['sourceId'] = sourceId;
      return casts;
    });
  }
  function fetchDamageDone(reportId, apiKey, sourceId) {
    var url = 'https://classic.warcraftlogs.com:443/v1/report/tables/damage-done/'
    + reportId + '?end=1000000000000&sourceid=' + sourceId
    + '&filter=' +  encodeURIComponent('encounterID in (610, 611, 612, 613, 614, 615, 616, 617, 631)')
    + '&api_key=' + apiKey;
    return fetch(url).then(function(response) {
      return response.json();
    }).then(function(json) {
      var total = totalDamage(json['entries']);
      var miss = missPercent(json['entries']);
      var crit = critPercent(json['entries']);
      var parry = parryPercent(json['entries']);
      var executes = countExecutes(json['entries']);
      return {
        'type': 'damage-done',
        'sourceId': sourceId,
        'totalDamage': total,
        'meleeMisses': miss[0],
        'meleeAttempts': miss[1],
        'critHits': crit[0],
        'totalAttacks': crit[1],
        'totalParries': parry[0],
        'executes': executes,
      }
    });
  }
  function fetchWarriors(reportId, apiKey) {
    var url = 'https://classic.warcraftlogs.com:443/v1/report/fights/'
    + reportId + '?api_key=' + apiKey;
    return fetch(url).then(response => {
      return response.json()
    }).then(json => {
      var warriors = [];
      json['friendlies'].forEach(function(friendly) {
        if (friendly['type'] == 'Warrior') {
          warriors.push(friendly);
        }
      });
      return warriors;
    });
  }
  function fetchReport(reportId, apiKey) {
    return fetchWarriors(reportId, apiKey).then(warriors => {
      var requests = [];
      warriors.forEach(warrior => {
        const bfs = fetchBuffs(reportId, apiKey, warrior['id']).then(v => {
          v['sourceName'] = warrior['name'];
          return v;
        });
        requests.push(bfs);
        const dmg = fetchDamageDone(reportId, apiKey, warrior['id']).then(v => {
          v['sourceName'] = warrior['name'];
          return v;
        });
        requests.push(dmg);
        const cst = fetchCasts(reportId, apiKey, warrior['id']).then(v => {
          v['sourceName'] = warrior['name'];
          return v;
        });
        requests.push(cst);
      });
      return Promise.all(requests).then(values => {
        return values;
      });
    });
  }
  function getReport(reportId, apiKey) {
    const result = new Promise((resolve, reject) => {
      var report = null;//localStorage.getObject(reportId);
      if (!report) {
        console.log('Fetching remote report');
        fetchReport(reportId, apiKey).then(report => {
          localStorage.removeItem(reportId);
          localStorage.setObject(reportId, report);
          resolve(report);
        });
      } else {
        console.log('Returning local report');
        resolve(report);
      }
    });
    return result;
  }
  function summarize(report) {
    var summary = {};
    report.forEach(row => {
      const key = row['sourceName'];
      if (!summary[key]) {
        summary[key] = {
          'name': key,
          'totalDamage': 0,
          'meleeMisses': 0,
          'meleeAttempts': 0,
          'totalParries': 0,
          'totalAttacks': 0,
          'critHits': 0,
          'sunders': 0,
          'bloodThirsts': 0,
          'executes': 0,
          'heroicStrikes': 0,
          'diamondFlaskUptime': 0,
          'diamondFlaskUses': 0,
          'flurryUptime': 0,
          'windfuryUptime': 0,
          'windfuryUses': 0,
          'crusaderUptime': 0,
          'recklessnessUptime': 0,
          'bloodFuries': 0,
        };
      }
      if (row.type == 'buffs') {
        if (row['Recklessness']) {
          summary[key].diamondFlaskUptime += (row['Diamond Flask'].totalUptime || 0) / (row.totalTime || 1.0);
        }
        if (row['Diamond Flask']) {
          summary[key].diamondFlaskUses += (row['Diamond Flask'].totalUses || 0);
        }
        if (row['Flurry']) {
          summary[key].flurryUptime += (row['Flurry'].totalUptime || 0) / (row.totalTime || 1.0);
          summary[key].flurryUses += (row['Flurry'].totalUses || 0);
        }
        if (row['Windfury Totem']) {
          summary[key].windfuryUptime += (row['Windfury Totem'].totalUptime || 0) / (row.totalTime || 1.0);
          summary[key].windfuryUses += (row['Windfury Totem'].totalUses || 0);
        }
        if (row['Holy Strength']) {
          summary[key].crusaderUptime += (row['Holy Strength'].totalUptime || 0) / (row.totalTime || 1.0);
        }
        if (row['Recklessness']) {
          summary[key].recklessnessUptime += (row['Recklessness'].totalUptime || 0) / (row.totalTime || 1.0);
        }
        if (row['Blood Fury']) {
          summary[key].bloodfuryUptime += (row['Blood Fury'].totalUptime || 0) / (row.totalTime || 1.0);
        }
      } else {
        summary[key].totalDamage += (row.totalDamage || 0);
        summary[key].meleeMisses += (row.meleeMisses || 0);
        summary[key].meleeAttempts += (row.meleeAttempts || 0);
        summary[key].totalParries += (row.totalParries || 0);
        summary[key].totalAttacks += (row.totalAttacks || 0);
        summary[key].critHits += (row.critHits || 0);
        summary[key].sunders += (row['Sunder Armor'] || 0);
        summary[key].bloodThirsts += (row['Bloodthirst'] || 0);
        summary[key].executes += (row['executes'] || 0);
        summary[key].heroicStrikes += (row['Heroic Strike'] || 0);
        summary[key].bloodFuries += (row['Blood Fury'] || 0);
      }
    });
    return Object.values(summary);
  }
  function update() {
    const reportId = document.getElementById('reportid').value;
    const apiKey = document.getElementById('apikey').value;
    document.getElementById('result-table-body').removeAllChildren();
    getReport(reportId, apiKey).then(report => {
      const summary = summarize(report).sort((a,b) => {
        if (a.totalDamage < b.totalDamage) { return -1; }
        if (a.totalDamage > b.totalDamage) { return 1; }
        return 0;
      });
      summary.forEach(row => {
        var el = createWarriorElement(row);
        document.getElementById('result-table-body').appendChild(el);
      });
    });
    return false;
  }
  function init() {
    var url = new URL(document.location.href);
    var reportId = url.searchParams.get('reportid');
    var apiKey = url.searchParams.get('apikey');
    if (reportId && apiKey) {
      getReport(reportId, apiKey).then(report => {
        const summary = summarize(report).sort((a,b) => {
          if (a.totalDamage < b.totalDamage) { return -1; }
          if (a.totalDamage > b.totalDamage) { return 1; }
          return 0;
        });
        summary.forEach(row => {
          var el = createWarriorElement(row);
          document.getElementById('result-table-body').appendChild(el);
        });
      });
    }
    document.getElementById('form').onsubmit = update;
  }
  window.onload = init;
  </script>
</body>
</html>
